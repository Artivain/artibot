/*
 * Module Giveaways par GoudronViande24
 * BasÃ© sur le module discord-giveaways par @androz2091
*/

const { MessageEmbed, Permissions } = require("discord.js");
const { SlashCommandBuilder } = require("@discordjs/builders");
const { GiveawaysManager } = require('discord-giveaways');
const fs = require("fs");
const path = require("path");
const ms = require('ms');
var manager;

module.exports = {
	// ########################################
	// Create the command with all the options
	// ########################################

	data: new SlashCommandBuilder()
		.setName("giveaway")
		.setDescription(
			"CrÃ©er et gÃ©rer des giveaways."
		)
		.addSubcommand(subcommand =>
			subcommand
				.setName('create')
				.setDescription('CrÃ©er un giveaway')
				.addStringOption(option =>
					option
						.setName("prix")
						.setDescription("Le prix qui sera Ã  gagner dans le giveaway.")
						.setRequired(true)
				)
				.addStringOption(option =>
					option
						.setName("durÃ©e")
						.setDescription("Le temps avant la fin du giveaway. Exemples: '5h', '2d'")
						.setRequired(true)
				)
				.addIntegerOption(option =>
					option
						.setName("gagnants")
						.setDescription("Nombre de gagnants.")
						.setRequired(true)
				)
				.addUserOption(option =>
					option
						.setName("crÃ©ateur")
						.setDescription("Utilisateur qui hÃ©berge le giveaway (sponsor, donateur, etc.). Par dÃ©faut, c'est toi.")
				)
				.addChannelOption(option =>
					option
						.setName("channel")
						.setDescription("Le salon dans lequel le giveaway sera publiÃ©.")
				)
		)
		.addSubcommand(subcommand =>
			subcommand
				.setName('create-drop')
				.setDescription('CrÃ©er un drop')
				.addStringOption(option =>
					option
						.setName("prix")
						.setDescription("Le prix qui sera Ã  gagner dans le drop.")
						.setRequired(true)
				)
				.addIntegerOption(option =>
					option
						.setName("gagnants")
						.setDescription("Nombre de gagnants.")
						.setRequired(true)
				)
				.addUserOption(option =>
					option
						.setName("crÃ©ateur")
						.setDescription("Utilisateur qui hÃ©berge le drop (sponsor, donateur, etc.). Par dÃ©faut, c'est toi.")
				)
				.addChannelOption(option =>
					option
						.setName("channel")
						.setDescription("Le salon dans lequel le drop sera lancÃ©.")
				)
		)
		.addSubcommand(subcommand =>
			subcommand
				.setName('reroll')
				.setDescription('Trouver un ou plusieurs nouveau(x) gagnant(s) pour un giveaway terminÃ©')
				.addStringOption(option =>
					option
						.setName("id")
						.setDescription("Le ID du message du giveaway.")
						.setRequired(true)
				)
		)
		.addSubcommand(subcommand =>
			subcommand
				.setName('edit')
				.setDescription('Modifier un giveaway.')
				.addStringOption(option =>
					option
						.setName("id")
						.setDescription("Le ID du message du giveaway.")
						.setRequired(true)
				)
				.addStringOption(option =>
					option
						.setName("option")
						.setDescription("Quelle option modifier dans le giveaway?")
						.addChoice("Nombre de gagnants", "winnerCount")
						.addChoice("Prix Ã  gagner", "prize")
						.addChoice("Ajouter du temps", "time")
						.setRequired(true)
				)
				.addStringOption(option =>
					option
						.setName("valeur")
						.setDescription("La valeur de la modification.")
						.setRequired(true)
				)
		)
		.addSubcommand(subcommand =>
			subcommand
				.setName('end')
				.setDescription('Termine immÃ©diatement un giveaway.')
				.addStringOption(option =>
					option
						.setName("id")
						.setDescription("Le ID du message du giveaway.")
						.setRequired(true)
				)
		),

	// ########################################
	// Initialize the manager on bot statup
	// ########################################

	async init(client, config) {
		// Verify that the data directory exists
		if (!fs.existsSync(path.resolve(__dirname, "data", "giveaways.json"))) {
			if (!fs.existsSync(path.resolve(__dirname, "data"))) {
				console.log("[Giveaways] CrÃ©ation du dossier pour le stockage des donnÃ©es");
				fs.mkdirSync(path.resolve(__dirname, "data"));
			};
		};

		// Karens are gonna ask for this
		manager = new GiveawaysManager(client, {
			storage: path.resolve(__dirname, "data", "giveaways.json"),
			default: {
				botsCanWin: false,
				embedColor: config.embedColor,
				embedColorEnd: '#000000',
				reaction: 'ðŸŽ‰'
			}
		});

		console.log("[Giveaways] PrÃªt.");
	},

	async execute(interaction, config) {
		const command = interaction.options.getSubcommand();

		// ########################################
		// End subcommand
		// ########################################

		if (command == "end") {
			const messageId = interaction.options.getString("id");
			const giveaway = manager.giveaways.find((g) => g.guildId === interaction.guildId && g.messageId === messageId);

			if (!giveaway) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Giveaway introuvable.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const isGiveawayOwner = giveaway.hostedBy.slice(0, -1).substring(2) == interaction.member.id;
			const isAdmin = interaction.member.permissions.has(Permissions.FLAGS.ADMINISTRATOR);

			if (!isAdmin && !isGiveawayOwner) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("**Vous ne pouvez pas exÃ©cuter cette commande.**\nVous devez avoir les permissions administrateur ou Ãªtre celui qui hÃ©berge le giveaway.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			if (giveaway.ended) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Le giveaway est dÃ©jÃ  terminÃ©.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			var embed = await manager.end(messageId).then(() => {
				return new MessageEmbed()
					.setColor(config.embedColor)
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Le giveaway a bien Ã©tÃ© terminÃ©.");
			})
				.catch(() => {
					return new MessageEmbed()
						.setColor("RED")
						.setTitle("Giveaways")
						.setTimestamp()
						.setFooter(config.botName, config.botIcon)
						.setDescription("Une erreur est survenue.");
				});
		};

		// ########################################
		// Edit subcommand
		// ########################################

		if (command == "edit") {
			const messageId = interaction.options.getString("id");
			const giveaway = manager.giveaways.find((g) => g.guildId === interaction.guildId && g.messageId === messageId);

			if (!giveaway) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Giveaway introuvable.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const isGiveawayOwner = giveaway.hostedBy.slice(0, -1).substring(2) == interaction.member.id;
			const isAdmin = interaction.member.permissions.has(Permissions.FLAGS.ADMINISTRATOR);

			if (!isAdmin && !isGiveawayOwner) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("**Vous ne pouvez pas exÃ©cuter cette commande.**\nVous devez avoir les permissions administrateur ou Ãªtre celui qui hÃ©berge le giveaway.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			if (giveaway.ended) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Impossible de modifier un giveaway terminÃ©.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const option = interaction.options.getString("option");
			const value = interaction.options.getString("valeur");

			if (option == "winnerCount") {
				if (!isNaN(value) && parseInt(value) > 0) {
					var settings = { newWinnerCount: parseInt(value) };
				} else {
					const errorEmbed = new MessageEmbed()
						.setColor("RED")
						.setTitle("Giveaways")
						.setTimestamp()
						.setFooter(config.botName, config.botIcon)
						.setDescription("La valeur entrÃ©e est invalide.");

					await interaction.reply({
						embeds: [errorEmbed],
						ephemeral: true
					});

					return
				};
			};

			if (option == "prize") {
				var settings = { newPrize: value };
			};

			if (option == "time") {
				var settings = { addTime: ms(value) };
			};

			var embed = await manager.edit(messageId, settings).then(() => {
				return new MessageEmbed()
					.setColor(config.embedColor)
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Le giveaway a bien Ã©tÃ© modifiÃ©.");
			})
				.catch(() => {
					return new MessageEmbed()
						.setColor("RED")
						.setTitle("Giveaways")
						.setTimestamp()
						.setFooter(config.botName, config.botIcon)
						.setDescription("Une erreur est survenue.");
				});
		};

		// ########################################
		// Reroll subcommand
		// ########################################

		if (command == "reroll") {
			const messageId = interaction.options.getString("id");
			const giveaway = manager.giveaways.find((g) => g.guildId === interaction.guildId && g.messageId === messageId);

			if (!giveaway) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Giveaway introuvable.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const isGiveawayOwner = giveaway.hostedBy.slice(0, -1).substring(2) == interaction.member.id;
			const isAdmin = interaction.member.permissions.has(Permissions.FLAGS.ADMINISTRATOR);

			if (!isAdmin && !isGiveawayOwner) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("**Vous ne pouvez pas exÃ©cuter cette commande.**\nVous devez avoir les permissions administrateur ou Ãªtre celui qui hÃ©berge le giveaway.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			var embed = await manager.reroll(messageId, {
				winnerCount: 1,
				messages: {
					congrat: "ðŸŽ‰ FÃ©licitations, {winners}! ðŸŽ‰\nVous avez gagnÃ© **{this.prize}**!",
					error: "Aucun participant valide, impossible de dÃ©signer un gagnant pour **{this.prize}**."
				}
			}).then(() => {
				return new MessageEmbed()
					.setColor(config.embedColor)
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("Le reroll a Ã©tÃ© effectuÃ©.");
			})
				.catch(() => {
					return new MessageEmbed()
						.setColor("RED")
						.setTitle("Giveaways")
						.setTimestamp()
						.setFooter(config.botName, config.botIcon)
						.setDescription("Une erreur est survenue.");
				});
		};

		// ########################################
		// Create subcommand
		// ########################################

		if (command == "create") {
			if (interaction.options.getChannel("channel")) {
				var isSameGuild = interaction.channel.guild.id == interaction.options.getChannel("channel").guild.id;
			} else var isSameGuild = true;

			if (!interaction.member.permissions.has(Permissions.FLAGS.ADMINISTRATOR) && isSameGuild) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("**Vous ne pouvez pas exÃ©cuter cette commande.**\nVous devez avoir les permissions administrateur.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const duration = interaction.options.getString("durÃ©e"),
				winnerCount = interaction.options.getInteger('gagnants'),
				prize = interaction.options.getString('prix');

			if (interaction.options.getChannel("channel")) {
				var channel = interaction.options.getChannel("channel");
				if (channel.type !== "GUILD_TEXT") {
					return interaction.reply({
						content: "Impossible de crÃ©er le giveaway dans ce channel.",
						ephemeral: true
					});
				};
			} else {
				var channel = interaction.channel;
			}

			if (interaction.options.getUser("crÃ©ateur")) {
				var hostedBy = interaction.options.getUser("crÃ©ateur");
			} else {
				var hostedBy = interaction.member.user;
			};

			await manager.start(channel, {
				duration: ms(duration),
				winnerCount,
				prize,
				hostedBy,
				messages: {
					giveawayEnded: "Giveaway terminÃ©.",
					inviteToParticipate: "RÃ©agis avec ðŸŽ‰ pour participer!",
					winMessage: "ðŸŽ‰ FÃ©licitations, {winners}! ðŸŽ‰\nVous avez gagnÃ© **{this.prize}**!",
					drawing: "Tirage ({this.winnerCount} gagnant(s)): {timestamp}.",
					embedFooter: {
						text: config.botName,
						iconURL: config.botIcon
					},
					noWinner: "Giveaway annulÃ©, aucun participant n'est Ã©ligible.",
					winners: "Gagnant(s):",
					endedAt: "Terminait le",
					hostedBy: "PrÃ©sentÃ© par {this.hostedBy}"
				}
			});

			var embed = new MessageEmbed()
				.setColor(config.embedColor)
				.setTitle("Giveaways")
				.setTimestamp()
				.setFooter(config.botName, config.botIcon)
				.setDescription("Le giveaway a bien Ã©tÃ© crÃ©Ã©!");
		};

		// ########################################
		// Create drop subcommand
		// ########################################

		if (command == "create-drop") {
			if (interaction.options.getChannel("channel")) {
				var isSameGuild = interaction.channel.guild.id == interaction.options.getChannel("channel").guild.id;
			} else var isSameGuild = true;

			if (!interaction.member.permissions.has(Permissions.FLAGS.ADMINISTRATOR) && isSameGuild) {
				const errorEmbed = new MessageEmbed()
					.setColor("RED")
					.setTitle("Giveaways")
					.setTimestamp()
					.setFooter(config.botName, config.botIcon)
					.setDescription("**Vous ne pouvez pas exÃ©cuter cette commande.**\nVous devez avoir les permissions administrateur.");

				await interaction.reply({
					embeds: [errorEmbed],
					ephemeral: true
				});

				return
			};

			const winnerCount = interaction.options.getInteger('gagnants'),
				prize = interaction.options.getString('prix');

			if (interaction.options.getChannel("channel")) {
				var channel = interaction.options.getChannel("channel");
				if (channel.type !== "GUILD_TEXT") {
					return interaction.reply({
						content: "Impossible de crÃ©er le drop dans ce channel.",
						ephemeral: true
					});
				};
			} else {
				var channel = interaction.channel;
			}

			if (interaction.options.getUser("crÃ©ateur")) {
				var hostedBy = interaction.options.getUser("crÃ©ateur");
			} else {
				var hostedBy = interaction.member.user;
			};

			await manager.start(channel, {
				duration: ms("1d"),
				winnerCount,
				prize,
				hostedBy,
				messages: {
					dropMessage: "Soyez le premier Ã  rÃ©agir avec ðŸŽ‰ pour gagner!\n{this.winnerCount} gagnant(s)",
					giveawayEnded: "Drop terminÃ©.",
					winMessage: "ðŸŽ‰ FÃ©licitations, {winners}! ðŸŽ‰\nVous avez gagnÃ© **{this.prize}**!",
					embedFooter: {
						text: config.botName,
						iconURL: config.botIcon
					},
					noWinner: "Giveaway annulÃ©, aucun participant n'est Ã©ligible.",
					winners: "Gagnant(s):",
					endedAt: "Terminait le",
					hostedBy: "PrÃ©sentÃ© par {this.hostedBy}"
				},
				isDrop: true
			});

			var embed = new MessageEmbed()
				.setColor(config.embedColor)
				.setTitle("Giveaways")
				.setTimestamp()
				.setFooter(config.botName, config.botIcon)
				.setDescription("Le drop a bien Ã©tÃ© lancÃ©!");
		};

		await interaction.reply({
			embeds: [embed],
			ephemeral: true
		});
	}
};
